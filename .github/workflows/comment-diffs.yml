name: Comment diffs
on:
  workflow_dispatch:
  pull_request:
    branches:
      - main
    paths:
      - '.github/workflows/comment-diffs.yml'
      - 'packages/create-react-native-library/**'
      - '!**.md'

jobs:
  comment-diffs:
    runs-on: macos-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v3

      - name: Setup
        uses: ./.github/actions/setup

      - name: Build crnl
        run: |
          yarn workspace create-react-native-library prepare

      - name: Create library
        run: |
          ./packages/create-react-native-library/bin/create-react-native-library new-version \
            --slug @bob/react-native-test \
            --description test \
            --author-name test \
            --author-email test@test \
            --author-url https://test.test \
            --repo-url https://test.test \
            --type module-mixed \
            --languages java-objc \
            --no-local

      - name: Checkout to main
        run: git checkout main

      - name: Setup again
        uses: ./.github/actions/setup

      - name: Remove old build and build again
        run: |
          rm -rf ./packages/create-react-native-library/lib
          yarn workspace create-react-native-library prepare

      - name: Create library again
        run: |
          ./packages/create-react-native-library/bin/create-react-native-library old-version \
            --slug @bob/react-native-test \
            --description test \
            --author-name test \
            --author-email test@test \
            --author-url https://test.test \
            --repo-url https://test.test \
            --type module-mixed \
            --languages java-objc \
            --no-local

      - name: Diff the libraries
        run: diff -r old-version new-version
